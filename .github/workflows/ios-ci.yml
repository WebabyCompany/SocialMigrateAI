name: Build and Deploy React to Apache (socialmigrateai)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # Jak tylko dodasz package-lock.json do repo, możesz włączyć cache:
          # cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json -> npm ci"
            npm ci
          else
            echo "No package-lock.json -> npm install"
            npm install
          fi

      - name: Build
        run: npm run build   # Vite -> dist/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: dist
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: ./build_artifact

      - name: Show downloaded files (debug)
        run: |
          echo "Zawartość ./build_artifact:"
          ls -R ./build_artifact

      - name: Install rsync and ssh client
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

          # Konfiguracja hosta "target" używanego w rsync/ssh
          printf "Host target\n  HostName %s\n  User %s\n  Port %s\n  IdentityFile ~/.ssh/id_deploy\n  StrictHostKeyChecking no\n" \
            "${{ secrets.SSH_HOST }}" "${{ secrets.SSH_USER }}" "${{ secrets.SSH_PORT }}" > ~/.ssh/config

      - name: Deploy build to server via rsync
        env:
          SSH_TARGET_DIR: ${{ secrets.SSH_TARGET_DIR }}
        run: |
          # UWAGA: download-artifact dodaje podkatalog z nazwą artefaktu: react-build
          if [ -d "./build_artifact/react-build/dist" ]; then
            SRC_DIR="./build_artifact/react-build/dist/"
          elif [ -d "./build_artifact/react-build/build" ]; then
            # Zostawione na wszelki wypadek, gdybyś kiedyś użył CRA
            SRC_DIR="./build_artifact/react-build/build/"
          else
            echo "Brak katalogu build ani dist w pobranym artefakcie" && exit 1
          fi

          echo "Kopiuję z: $SRC_DIR do: $SSH_TARGET_DIR"
          rsync -avz --delete "$SRC_DIR" target:"$SSH_TARGET_DIR"

      - name: (Optional) Reload Apache
        run: |
          ssh target "sudo systemctl reload apache2 || sudo systemctl restart apache2"

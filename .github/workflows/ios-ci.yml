name: Build and Deploy SocialMigrateAI

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build React App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # Odkomentuj po dodaniu package-lock.json:
          # cache: npm

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json -> using npm ci"
            npm ci
          else
            echo "No lockfile -> using npm install"
            npm install
          fi

      - name: Build app
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: dist
          if-no-files-found: error

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: ./build_artifact

      - name: Show downloaded files (debug)
        run: |
          echo "Zawartość ./build_artifact:"
          ls -R ./build_artifact

      - name: Install rsync and SSH client
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

          printf "Host target\n  HostName %s\n  User %s\n  Port %s\n  IdentityFile ~/.ssh/id_deploy\n  StrictHostKeyChecking no\n" \
            "${{ secrets.SSH_HOST }}" "${{ secrets.SSH_USER }}" "${{ secrets.SSH_PORT }}" > ~/.ssh/config

      - name: Deploy files via rsync
        env:
          SSH_TARGET_DIR: ${{ secrets.SSH_TARGET_DIR }}
        run: |
          echo "Zawartość ./build_artifact (debug):"
          ls -R ./build_artifact || true

          SRC_DIR="./build_artifact"
          echo "Kopiuję z: $SRC_DIR do: $SSH_TARGET_DIR"
          rsync -avz --delete "$SRC_DIR"/ target:"$SSH_TARGET_DIR"

      - name: Reload Apache
        run: |
          ssh target "sudo systemctl reload apache2 || sudo systemctl restart apache2"
